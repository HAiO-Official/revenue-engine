# HAiO - Revenue Engine & Agent Autonomy (Solana Seoulana Hackathon Submission)

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**HAiO is building the future of music creation and monetization, powered by AI Agents and governed by transparent Web3 principles on Solana.** This repository contains the core implementation of our **Revenue Engine** and demonstrates the **Autonomous Economic Activity** of HAiO Agents, developed for the Solana Seoulana Hackathon.

## üöÄ The Vision: A Sustainable & Autonomous Music Ecosystem

The rise of AI music generation presents incredible opportunities but also new challenges: How do we manage AI operational costs? How do we fairly distribute the value created by AI? How do we build a system that can grow and adapt?

HAiO tackles these challenges head-on by building a **Web3-native infrastructure** where:

1. **AI Agents Act Autonomously:** Our Agents don't just create; they participate in the economy. They manage operational costs (like GPU usage via ATH tokens), swap assets on DEXs (Mock), and actively contribute to token value (burning $HAiO).

2. **Value Distribution is Transparent & Automated:** The **Revenue Engine**, built on Solana smart contracts, ensures that all net revenue generated by Agents ($HAiO) is distributed according to clear, on-chain rules to ecosystem participants (NFT Stakers, DAO, Developers).

3. **The Ecosystem is Sustainable & Scalable:** The core engine is designed as a **Hub**, allowing various future modules (Licensing, Data Rewards, Live Agent Features, 3rd Party Agents) to plug in seamlessly, creating a constantly evolving and enriching platform.

## üí° How it Works: Core Mechanism

This hackathon project focuses on demonstrating the core economic loop:

1. **Revenue Inflow:** External revenue (simulated as USDC, potentially SOL or others) arrives in the Agent's dedicated `Agent Wallet`.

2. **Agent Autonomy (Off-Chain Worker + On-Chain Interaction):**
   * An off-chain **Agent (Worker)** monitors the `Agent Wallet`.
   * **Budget Allocation & Ops Costs:** The Agent calculates and utilizes funds for operational costs. For instance, it swaps a portion of incoming USDC to Mock ATH (using the `Mock Swap Program`) and transfers it to a designated Aethir wallet to pay for simulated GPU resources. This happens **off-chain first**, ensuring operational continuity with flexibility.
   * **Value Accrual & Standardization:** The Agent swaps the *remaining* USDC for the native `$HAiO` token using the `Mock Swap Program`.
   * **Deflationary Mechanism:** A portion of the swapped `$HAiO` is automatically **burned** via SPL Token Program instruction, increasing scarcity.
   * **Revenue Transfer:** The final net `$HAiO` revenue is transferred (SPL transfer) to the on-chain `Revenue Safe`.

3. **Transparent Distribution (On-Chain Programs):**
   * The **`RevenueEngine` Program** is triggered (manually in demo, can be automated).
   * It reads the `$HAiO` balance in the `Revenue Safe` and the distribution ratios (Œ≤% for Stakers, Œ≥% for DAO, Œ¥% for Devs) stored in the `EngineState Account`.
   * It calculates distribution amounts and **transfers the `$HAiO` via CPI** (Cross-Program Invocation) to the respective PDAs: `Reward Pool PDA`, `DAO Treasury PDA`, `Developer Treasury PDA`. The `Revenue Safe`'s authority (the `EngineState` PDA) signs these transfers.
   * It updates the global `reward_per_token_cumulative` in the `EngineState Account` for the staking rewards (Lazy Calculation).

4. **User Rewards (On-Chain Staking):**
   * Users stake their **Agent NFTs** using the **`Staking Program`**.
   * The `Staking Program` tracks individual stakes (`NftStakeState Account`) and interacts with the `RevenueEngine` (via CPI) to update the total staked amount.
   * Users can **claim** their accrued rewards at any time. The `Staking Program` calculates the claimable amount based on the global `reward_per_token_cumulative` and the user's `reward_debt` (Lazy Calculation) and transfers the $HAiO from the `Reward Pool PDA` (signing with its own authority PDA).

### High-Level Architecture Diagram

![High-Level Architecture Diagram](images/high-level-arch.png)

*Revenue flows into the Agent Wallet. The off-chain Agent Worker processes it (pays costs, swaps, burns) and sends the net $HAiO to the on-chain Revenue Engine. The Engine distributes funds transparently based on on-chain rules to Participants, who engage back with the system via staking.*

## üõ†Ô∏è Tech Stack Used

### Blockchain
- **Solana (Devnet)**: Leveraging its high speed and low transaction fees for efficient agent actions and reward distribution.

### Smart Contracts
- **Rust**
- **Anchor Framework (v0.31.0)**: For rapid development, security, and easier client-side integration.

### Off-Chain Agent (Worker)
- **Node.js + TypeScript**: For asynchronous operations, monitoring, and interacting with Solana.
- **@solana/web3.js**: Core Solana library.
- **@solana/spl-token**: For interacting with SPL tokens (transfer, burn).
- **@coral-xyz/anchor**: For interacting with Anchor programs (calling instructions, fetching state).

### Tokens
- **SPL Token Standard**: For $HAiO, USDC, ATH mocks, and the Agent NFT.

### Frontend Demo (Optional)
- React, TypeScript, Solana Wallet Adapter.

## üèóÔ∏è Project Structure

```
haio-seoulana/
‚îú‚îÄ‚îÄ programs/             # Solana Smart Contracts (Anchor)
‚îÇ   ‚îú‚îÄ‚îÄ revenue_engine/   # Core distribution logic & state
‚îÇ   ‚îú‚îÄ‚îÄ staking_program/  # NFT staking & reward claim logic
‚îÇ   ‚îî‚îÄ‚îÄ mock_swap_program/ # Demo swap functionality (USDC<>HAiO, USDC<>ATH)
‚îú‚îÄ‚îÄ app/                  # Off-Chain Agent (Worker) implementation
‚îÇ   ‚îî‚îÄ‚îÄ src/agent.ts      # Main worker logic
‚îú‚îÄ‚îÄ scripts/              # Initialization and helper scripts
‚îÇ   ‚îî‚îÄ‚îÄ init.ts           # Sets up accounts, mints tokens, initializes programs
‚îú‚îÄ‚îÄ tests/                # End-to-end tests
‚îÇ   ‚îî‚îÄ‚îÄ haio-seoulana.ts
‚îú‚îÄ‚îÄ keypairs/             # Keypairs for Devnet testing (Mints, Wallets)
‚îú‚îÄ‚îÄ target/               # Compiled artifacts (IDLs, types) - Gitignored usually
‚îú‚îÄ‚îÄ frontend/             # React Frontend for Demo (Optional)
‚îú‚îÄ‚îÄ Anchor.toml           # Anchor configuration
‚îú‚îÄ‚îÄ Cargo.toml            # Rust workspace configuration
‚îî‚îÄ‚îÄ package.json          # Node.js dependencies & scripts
```

## üìö Technical Architecture Details

### A. Core Concepts

#### Agent Wallet vs Revenue Safe:
- **Agent Wallet (Operational Wallet)**: The off-chain Agent's primary interface for interacting with the world. It receives diverse incoming revenue streams (USDC, SOL, etc.) and holds the private key, enabling flexible, immediate actions like paying operational costs (e.g., sending ATH for GPU time), swapping assets via DEXs/mocks, and executing deflationary burns. Its primary goal is operational efficiency and autonomy. After processing, it forwards only standardized net revenue ($HAiO) to the Revenue Safe.
- **Revenue Safe**: An on-chain SPL token account acting as the single, verifiable entry point for net revenue into the core distribution system. It holds $HAiO received from one or more Agent Wallets. Its balance serves as the basis for the RevenueEngine's distribution calculations, ensuring transparency and predictability in the final distribution phase. Its authority is set to the EngineState PDA, ensuring only the RevenueEngine program can initiate transfers from it.

#### RevenueEngine Program:
- The on-chain rulebook and executor for HAiO's ecosystem-wide economic policy.
- Manages the global EngineState Account, which stores critical parameters like distribution ratios (Œ≤, Œ≥, Œ¥), total staked amount, and the cumulative reward rate.
- Its distribute_revenue function is the core: it reads the Revenue Safe balance, calculates shares based on the ratios in EngineState, and executes atomic SPL Token transfers via CPI to the designated PDA accounts (Reward Pool PDA, DAO Treasury PDA, Developer Treasury PDA). The EngineState PDA signs for these outgoing transfers from the Revenue Safe.
- Provides CPI endpoints (increase/decrease_total_staked) allowing the Staking Program to update the global total_staked_amount reliably, ensuring reward calculations remain accurate.

#### Staking Program & Lazy Calculation:
- Manages user interactions related to NFT staking and reward claiming.
- Employs the Lazy Calculation pattern for scalability:
  - When rewards are distributed by the RevenueEngine, only the global reward_per_token_cumulative is updated. No per-staker calculations occur at this stage.
  - When a user claims rewards (or unstakes), the Staking Program reads the current global rate and compares it to the user's last recorded rate (reward_debt stored in their NftStakeState Account).
  - The difference, multiplied by the staked amount, determines the user's individual accrued rewards at that precise moment. This calculation happens on-demand per user, distributing the computational load and avoiding transaction size limits, even with hundreds of thousands of stakers.
  - The program uses its own PDA (Reward Pool Authority PDA) to sign the outgoing reward transfer from the Reward Pool PDA to the user.

#### Off-Chain Agent & Realistic Approach:
- We acknowledge the ideal Web3 vision involves maximum on-chain logic. However, for complex, dynamic, and external-facing tasks like interacting with variable-cost services (GPU, APIs), optimizing DEX swaps, or implementing nuanced operational logic, an off-chain Agent offers crucial flexibility and development speed.
- Our chosen architecture balances this:
  - **Flexibility Off-Chain**: Agent handles operational complexity.
  - **Transparency On-Chain**: The final net revenue settlement and its distribution follow strict, verifiable on-chain rules enforced by the RevenueEngine and Staking Program.
  - **Future Enhancement**: We plan to enhance transparency by implementing on-chain attestations for off-chain actions (e.g., posting hashes of spending logs) and potentially migrating highly standardized, critical budget components (like a fixed-rate GPU cost) to PDA-based management later.

### B. Critical On-Chain Accounts

#### EngineState Account (PDA):
- **Purpose**: Stores the global configuration and real-time economic state for the RevenueEngine. This includes distribution ratios (Œ≤, Œ≥, Œ¥), the address of the Revenue Safe and destination PDAs, the current total_staked_amount, and the crucial reward_per_token_cumulative for lazy reward calculations.
- **Seed**: ["engine_state_v1"] (Ensures a single global state for the engine).
- **Owner**: RevenueEngine Program.
- **Typical Authority (for updates)**: Initially set to the Admin/Deployer wallet, intended to be transferred to a DAO later.

#### NftStakeState Account (PDA):
- **Purpose**: Tracks the staking details for a specific NFT staked by a specific user. Stores the user's wallet, the NFT mint address, the amount staked (currently 1), the reward_debt (the global cumulative rate at the time of their last interaction), staking timestamp, and a reference to the EngineState it belongs to.
- **Seed**: ["nft_stake", user_wallet_pubkey, nft_mint_pubkey] (Unique per user per NFT).
- **Owner**: Staking Program.

#### Revenue Safe Account (SPL Token Account):
- **Purpose**: The central holding account for net $HAiO revenue received from Agent Wallets, awaiting distribution by the RevenueEngine.
- **Mint**: $HAiO.
- **Authority (to transfer from)**: EngineState PDA. This is crucial ‚Äì only the RevenueEngine program, acting through its PDA, can move funds out of the safe during distribution.

#### Reward Pool PDA Account (SPL Token Account):
- **Purpose**: Holds the accumulated $HAiO allocated for NFT staker rewards (Œ≤%) after distribution from the Revenue Safe.
- **Mint**: $HAiO.
- **Authority (to transfer from)**: Staking Program's Reward Pool Authority PDA (derived from ["reward_pool_authority_seed"]). This ensures only the Staking Program, when processing a user's valid claim, can withdraw funds from this pool.

#### DAO Treasury PDA Account (SPL Token Account):
- **Purpose**: Holds the accumulated $HAiO allocated for DAO operations (Œ≥%) after distribution.
- **Mint**: $HAiO.
- **Authority**: Typically, a DAO-controlled multisig wallet or a governance program PDA. RevenueEngine only needs authority to transfer into this account (which is implicit via its own PDA signing).

#### Developer Treasury PDA Account (SPL Token Account):
- **Purpose**: Holds the accumulated $HAiO allocated for developer incentives/rewards (Œ¥%) after distribution.
- **Mint**: $HAiO.
- **Authority**: The developer's wallet, a platform multisig, or another designated authority. Similar to the DAO Treasury, RevenueEngine primarily transfers into it.

### C. Sequence Diagrams

#### Agent Autonomous Processing
![Agent Autonomous Processing](images/agent-autonomous-processing.png)

*This diagram shows the off-chain Agent Worker monitoring the Agent Wallet, detecting incoming USDC, performing mock swaps (USDC->ATH, USDC->$HAiO), paying external costs (sending ATH), burning a portion of $HAiO, and finally transferring the net $HAiO revenue to the on-chain Revenue Safe. It highlights the Agent's autonomy in pre-processing revenue before it hits the main distribution engine.*

#### On-Chain Distribution & Claim
![On-Chain Distribution](images/on-chain-distribution.png)

*This diagram details the on-chain process. It starts when the RevenueEngine's distribute_revenue function is called. It shows the Engine reading the Revenue Safe, calculating shares, transferring funds via CPI using the SPL Token Program to the Reward Pool and Treasury PDAs, and updating the global EngineState. It then illustrates a user claiming rewards, where the Staking Program reads the EngineState, calculates individual rewards, and initiates a CPI transfer from the Reward Pool to the user's wallet via the SPL Token Program.*

### D. Extension Scenarios

This Hub-and-Spoke model, centered around the RevenueEngine, provides a clear and robust foundation for adding diverse functionalities without compromising the core distribution mechanism's integrity or transparency (for the final distribution step).

#### Technical Connection Points:
- **Revenue Inflow Modules** (e.g., Licensing, Live Agent Tips, 3rd Party Agent Fees): These modules generate revenue in various forms (USDC, SOL, $HAiO). This revenue should ultimately be directed to the relevant Agent Wallet. An off-chain process (or sometimes an on-chain program for simple cases) might be needed to convert/consolidate this revenue before it enters the standard Agent processing pipeline (Swap/Burn/Transfer to Revenue Safe). 3rd Party Agents might send only a platform fee (e.g., $HAiO) to a designated HAiO platform wallet, which then potentially flows into a central Revenue Safe or operational fund.
- **Budget/Reward Outflow Modules** (e.g., Data/RSI Rewards, Live Agent Interaction Rewards, Social Agent Budget): These functionalities are funded by the outputs of the RevenueEngine. When distribute_revenue runs, the Œ≥% (DAO/Operations) or other specifically allocated funds are transferred to dedicated Treasury/Pool PDAs. The logic for these specific modules (e.g., DataRewardLogic, SocialAgentLogic) then interacts with these PDAs to disburse funds according to their own rules, often triggered by off-chain events or user actions. They do not directly interact with the Revenue Safe but consume the results of its distribution.
- **Staking Program**: Acts as both an input (updating total_staked_amount via CPI to RevenueEngine) and an output consumer (reading reward_per_token_cumulative from EngineState and withdrawing from Reward Pool PDA).

## üîÆ Future Roadmap & Vision

- **Mainnet Launch Preparation**: Security Audits (Smart Contracts & Worker logic), comprehensive testing on Testnet, refined key management strategy.
- **Real DEX Integration**: Replace Mock Swap Program with integration to leading Solana DEXs (e.g., Orca, Raydium, Jupiter) for real-world swaps, including slippage control and price fetching.
- **Progressive Decentralization**: Implement on-chain governance (e.g., Realms) for updating distribution ratios and key parameters. Gradually transfer EngineState authority to the DAO.
- **Expand Extension Modules**: Sequentially implement and integrate key expansion scenarios like Modular Licensing, ADI/RSI Rewards, and Live Agent features.
- **SDK & Developer Program**: Release SDKs and potentially standardized Agent templates to onboard 3rd party developers easily.

## üôè Acknowledgements

- Solana & Anchor communities for the powerful blockchain and development framework.

## üìÑ License

This project is licensed under the MIT License.